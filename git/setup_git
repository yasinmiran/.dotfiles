#!/usr/bin/env zsh

source "$DOTFILES_DIR/git/defaults"

# Generate SSH key in default location (~/.ssh/id_ed25519)
ssh-keygen -t ed25519 -C "wytm97@protonmail.com"

# Start the ssh-agent
eval "$(ssh-agent -s)"

# Detect the operating system
OS_TYPE=$(check_system)

# Create config file with necessary settings
if [[ "$OS_TYPE" == "Darwin" ]]; then
  # macOS specific SSH config
  cat >~/.ssh/config <<EOF
Host *
  AddKeysToAgent yes
  UseKeychain yes
  IdentityFile ~/.ssh/id_ed25519
EOF
elif [[ "$OS_TYPE" == "Linux" ]]; then
  # Linux specific SSH config
  cat >~/.ssh/config <<EOF
Host *
  AddKeysToAgent yes
  IdentityFile ~/.ssh/id_ed25519
EOF
fi

# Add private key to ssh-agent
if [[ "$OS_TYPE" == "Darwin" ]]; then
  ssh-add -K ~/.ssh/id_ed25519
else
  ssh-add ~/.ssh/id_ed25519
fi

# Copy public key to clipboard
if [[ "$OS_TYPE" == "Darwin" ]]; then
  pbcopy <~/.ssh/id_ed25519.pub
elif [[ "$OS_TYPE" == "Linux" ]]; then
  # Linux requires xclip or xsel to be installed for clipboard support
  if command -v xclip >/dev/null; then
    xclip -selection clipboard <~/.ssh/id_ed25519.pub
  elif command -v xsel >/dev/null; then
    xsel --clipboard <~/.ssh/id_ed25519.pub
  else
    echo "Clipboard utility not found. Please install xclip or xsel."
  fi
fi

# Test SSH connection, then verify fingerprint and username
# https://help.github.com/en/github/authenticating-to-github/testing-your-ssh-connection
ssh -T git@github.com
